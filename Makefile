# Note, FFTW version 3 must be installed to compile this code.
#
# It is assumed that the include file fftw3.h FFTW's static library files are in standard locations that GCC knows about.
# If this is not the case then you need to add the flag -I/wherever/fftw.h/is/located/at to CXXFLAGS
# and add the path of libfftw3.la to the environment variable LIBRARY_PATH.

#CXX = gcc
#CXXFLAGS = -Wno-unused-result -Wsign-compare -Wunreachable-code -DNDEBUG -g -fwrapv -O3 -Wall -Wstrict-prototypes -arch x86_64  -std=c++11 -ffast-math -march=native
#LDFLAGS = -arch x86_64 -lmkl -undefined dynamic_lookup 
#LD = g++

#CXX = gcc
CXXFLAGS = -Wall -std=c++11 -O3 -ffast-math -fwrapv -march=native

# Flags for linking with FFTW3:
LDFLAGS = -march=native -g -lfftw3 
# Flags for linking with Intel's MKL library which has an FFTW3-compatible interface and is typically faster on Intel chips:
#LDFLAGS = -march=native -g -L${MKLROOT}/lib -Wl,-rpath,${MKLROOT}/lib -lmkl_intel_lp64 -lmkl_sequential -lmkl_core -lpthread -lm -ldl

LD = $(CXX)

CROSSPROB_OBJECTS = build/crossprob.o build/ecdf1_mns2016.o build/ecdf1_m2023.o build/ecdf2.o build/fftwconvolver.o build/string_utils.o build/read_boundaries_file.o build/poisson_pmf.o build/common.o

CROSSPROB_MC_OBJECTS = build/crossprob_mc.o build/string_utils.o build/read_boundaries_file.o build/tinymt64.o build/common.o

all: build bin bin/crossprob bin/crossprob_mc

.PHONY: build bin test clean python depend

build:
	mkdir -p build

bin:
	mkdir -p bin

bin/crossprob: $(CROSSPROB_OBJECTS)
	$(LD) $(CROSSPROB_OBJECTS) $(LDFLAGS) -o $@ 

bin/crossprob_mc: $(CROSSPROB_MC_OBJECTS)
	$(LD) $(CROSSPROB_MC_OBJECTS) $(LDFLAGS) -o $@ 

build/%.o: src/%.cc
	$(CXX) -c -o $@ $< $(CXXFLAGS)

test: # Running "py.test" also works and produces nicer output.
	python tests/test_crossprob.py

clean:
	rm -rf build
	rm -rf bin
	rm -rf tests/__pycache__
	rm -f tests/*.pyc
	rm -f src/*.d
	rm -f python_extension/*

python:
	swig -c++ -o python_extension/crossprob.cc -python src/crossprob.i
	python setup.py build

depend:
	makedepend src/*.cc

# The following dependencies were generated by calling "make depend"
# DO NOT DELETE

src/common.o: src/common.hh
src/crossprob.o: src/common.hh src/read_boundaries_file.hh
src/crossprob.o: src/string_utils.hh src/ecdf1_mns2016.hh src/ecdf1_m2023.hh
src/crossprob.o: src/ecdf2.hh
src/crossprob_mc.o: src/string_utils.hh src/read_boundaries_file.hh
src/crossprob_mc.o: src/tinymt64.h
src/ecdf1_mns2016.o: src/ecdf1_mns2016.hh src/common.hh
src/ecdf1_m2023.o: src/ecdf1_m2023.hh src/common.hh src/poisson_pmf.hh
src/ecdf1_m2023.o: src/fftwconvolver.hh src/aligned_mem.hh src/string_utils.hh
src/ecdf2.o: src/ecdf2.hh src/fftwconvolver.hh src/aligned_mem.hh
src/ecdf2.o: src/common.hh src/poisson_pmf.hh src/string_utils.hh
src/ecdf2.o: src/read_boundaries_file.hh
src/fftw_wrappers.o: src/fftw_wrappers.hh src/aligned_mem.hh
src/fftwconvolver.o: src/fftwconvolver.hh src/aligned_mem.hh
src/poisson_pmf.o: src/poisson_pmf.hh src/aligned_mem.hh
src/read_boundaries_file.o: src/read_boundaries_file.hh src/string_utils.hh
src/string_utils.o: src/string_utils.hh
src/tinymt64.o: src/tinymt64.h
